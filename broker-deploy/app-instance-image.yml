#===============================  BROKER-API-IMAGE PLAYBOOK  ===============================#

---
- hosts: "{{ HOST }}"

  user: ec2-user
  become_method: sudo

  vars:
    REPO: https://github.com/fedspendingtransparency/data-act-broker-backend.git
    BRANCH: "{{ BRANCH }}"

  tasks:

#=============================== Copy Git Credentials from S3 Bucket ===============================#

    - name: copy broker git credentials from S3 Bucket
      become: true
      shell: "aws s3 cp s3://da-config/broker/id_rsa_broker_config /home/ec2-user/.ssh/id_rsa_broker_config --region us-gov-west-1"

    - name: change ownership of /home/ec2-user.ssh/
      become: true
      file: 
        path: /home/ec2-user/.ssh/
        owner: ec2-user
        recurse: yes

    - name: change mode for the id_rsa_broker_config
      become: true
      file:
        path: /home/ec2-user/.ssh/id_rsa_broker_config
        mode: 0400

#===============================  Git Checkout  ===============================#

    - name: checkout backend from git
      become: true
      git:
        repo: "{{ REPO }}"
        version: "{{ BRANCH }}"
        dest: "/data-act/backend" 
        accept_hostkey: true 
        force: yes
           
    - name: checkout broker config from git
      become: true
      git:
        repo: "git@github.com:fedspendingtransparency/data-act-broker-config.git"
        dest: "/data-act/config"
        accept_hostkey: true 
        force: yes 
        key_file: "/home/ec2-user/.ssh/id_rsa_broker_config"
      
    - name: assign ownership of api to ec2-user
      become: true
      file:
        path: /data-act/ 
        owner: ec2-user
        recurse: yes

    - name: assign ownership of tmp to ec2-user
      become: true
      file:
        path: /tmp
        owner: ec2-user
        recurse: yes
    
#===============================  Install PIP Packages  ===============================#

    - name: Install backend packages based on requirements.txt
      become: true 
      pip:
        chdir: /data-act/backend
        requirements: requirements.txt
        executable: pip3.5

    - name: Install server packages based on server_requirements.txt
      become: true
      pip:
        chdir: /data-act/backend
        requirements: server_requirements.txt
        executable: pip3.5

    - name: install python packages based on legacy_requirements.txt
      become: true
      pip:
        chdir: /data-act/backend
        requirements: legacy_requirements.txt
        executable: pip2

#===============================  Configure DataDog Key  ===============================#

    - name: copy datadog_key from S3
      become: true 
      shell: "aws s3 cp s3://da-config/shared/datadog_key.yml /etc/ --region us-gov-west-1"

    - name: load datadog_key var
      include_vars: /etc/datadog_key.yml

    - name: add Datadog license key to datadog.yaml
      become: true
      lineinfile:
        dest: /data-act/config/datadog/datadog.yaml
        regexp: '\s*api_key: .*'
        line: "api_key: {{ DD_KEY }}"

    - name: copy datadog.yml to it's home location
      become: true
      copy: 
        src: /data-act/config/datadog/datadog.yaml
        dest: /etc/datadog-agent/datadog.yaml

#===============================  EOF  ===============================#
